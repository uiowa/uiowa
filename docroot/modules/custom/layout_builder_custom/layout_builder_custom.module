<?php

/**
 * @file
 * Contains lb_enhancements.module.
 */

use Drupal\Core\Block\BlockPluginInterface;
use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_form_alter().
 */
function layout_builder_custom_form_alter(&$form, FormStateInterface $form_state, $form_id) {

  $form_ids = ['layout_builder_update_block', 'layout_builder_add_block'];

  // Only continue if this is one of the above forms.
  if (!in_array($form_id, $form_ids)) {
    return;
  }

  // Always set title field to not be required.
  $form['settings']['label']['#required'] = FALSE;

  if ($form_id == 'layout_builder_add_block') {
    // Set the display of the label to FALSE when adding a block.
    $form['settings']['label_display']['#default_value'] = FALSE;
  }

  $label = $form['settings']['label'];
  $label_display = $form['settings']['label_display'];

  unset($form['settings']['label']);
  unset($form['settings']['label_display']);

  $label += [
    '#states' => [
      'visible' => [
        ':input[name="settings[label_display]"]' => [
          'checked' => TRUE,
        ],
      ],
    ],
  ];

  $form['settings'] += [
    'label_display' => $label_display,
    'label' => $label,
  ];
}

/**
 * Implements hook_block_view_BASE_BLOCK_ID_alter().
 *
 * Adds a pre-render callback which allows changing the block content before
 * rendering.
 */
function layout_builder_custom_block_view_alter(array &$build, BlockPluginInterface $block) {
  $test = 'thing';
  // $build['#pre_render'][] = '_layout_builder_custom_block_content_multiple_pre_render';
}

/**
 * Pre-render callback for block user_login_block.
 *
 * Adds a link to the username reminder page.
 */
function _layout_builder_custom_block_content_multiple_pre_render(array $build) {
  $user_links = &$build['content']['user_links'];
  $items = &$user_links['#items'];
  $items['username-reminder'] = \Drupal::l(t('Look up your username'), new Url('username_reminder.reminder', [], [
    'attributes' => [
      'title' => t('Look up your username.'),
      'class' => ['username-reminder'],
    ],
  ]));
  return $build;
}
