<?php

/**
 * @file
 * Primary module hooks for Sitenow Intranet module.
 *
 * @DCG
 * This file is no longer required in Drupal 8.
 * @see https://www.drupal.org/node/2217931
 */

use Drupal\Core\Link;
use Drupal\Core\Url;

/**
 * Implements hook_preprocess_page().
 */
function sitenow_intranet_preprocess_block(&$variables) {
  $status_code = \Drupal::request()
    ?->attributes
    ?->get('exception')
    ?->getStatusCode();

  if (!is_null($status_code)) {
    switch ($variables['plugin_id']) {
      case 'page_title_block':
        $variables['attributes']['class'][] = 'block-padding__top';
        break;

      case 'system_breadcrumb_block':
        unset($variables['content']);
        break;

      case 'system_main_block':
        $config = \Drupal::config('sitenow_intranet.settings');
        switch ($status_code) {
          case 403:
            $variables['content'] = [
              '#markup' => check_markup($config->get('access_denied.message'), 'minimal'),
              '#prefix' => '<div class="text-align-center">',
              '#suffix' => '</div>',
            ];

            // If the user is logged in, show a logout link.
            if (\Drupal::currentUser()->isAuthenticated()) {
              $url = Url::fromRoute('user.logout');
              $link = Link::fromTextAndUrl(t('Logout'), $url);
              $variables['content']['logout_link'] = [
                '#markup' => $link->toString(),
                '#prefix' => '<p class="text-align-center">',
                '#suffix' => '</p>',
              ];
            }
            break;

          case 401:
            $variables['content'] = [
              '#markup' => check_markup($config->get('unauthorized.message'), 'minimal'),
              '#prefix' => '<div class="text-align-center">',
              '#suffix' => '</div>',
            ];
            break;

        }
        break;

    }
  }
}

/**
 * Implements hook_preprocess_page().
 */
function sitenow_intranet_preprocess_page(&$variables) {
  $status_code = \Drupal::request()
    ?->attributes
    ?->get('exception')
    ?->getStatusCode();

  if (!is_null($status_code)) {
    switch ($status_code) {
      case 403:
      case 401:
        $variables['action_menu']['#access'] = FALSE;
        $variables['primary_menu']['#access'] = FALSE;
        // @todo Do we need to set cache max-age to 0 here?
        break;

    }
  }
}

/**
 * Implements hook_preprocess_page_title().
 */
function sitenow_intranet_preprocess_page_title(&$variables) {
  $status_code = \Drupal::request()
    ?->attributes
    ?->get('exception')
    ?->getStatusCode();

  if (!is_null($status_code)) {
    $config = \Drupal::config('sitenow_intranet.settings');
    switch ($status_code) {
      case 403:
        $variables['title'] = $config->get('access_denied.title');
        $variables['title_attributes']['class'][] = 'text-align-center';
        if (!isset($variables['#title_attributes']['class'])) {
          $variables['#title_attributes']['class'] = [];
        }
        $variables['#title_attributes']['class'][] = 'text-align-center';
        break;

      case 401:
        $variables['title'] = $config->get('unauthorized.title');
        $variables['title_attributes']['class'][] = 'page-title';
        break;

    }
  }
}

/**
 * Implements hook_restrict_ip_access_denied_page_alter().
 */
function sitenow_intranet_restrict_ip_access_denied_page_alter(&$page) {
  $config = \Drupal::config('sitenow_intranet.settings');
  \Drupal::service('renderer')->addCacheableDependency($page, $config);

  if (isset($page['access_denied'])) {
    unset($page['access_denied']);
  }

  // Create our own access denied page and login.
  $page['main'] = [
    '#type' => 'html_tag',
    '#tag' => 'main',
    '#attributes' => [
      'role' => 'main',
      'class' => 'page__container',
    ],
    '#cache' => [
      'max-age' => 0,
    ],
  ];

  if (isset($page['logout_link'])) {
    $page['main']['logout_link'] = $page['logout_link'];
    $page['main']['logout_link']['#prefix'] = '<p class="text-align-center">';
    $page['main']['logout_link']['#suffix'] = '</p>';
    unset($page['logout_link']);
  }
}
