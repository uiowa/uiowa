<?php

/**
 * @file
 * Primary module hooks for SiteNow People module.
 *
 * @DCG
 * This file is no longer required in Drupal 8.
 * @see https://www.drupal.org/node/2217931
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Link;
use Drupal\Core\Url;
use Drupal\views\ViewExecutable;
use Drupal\Component\Utility\Html;
use Drupal\views\Views;
use Drupal\views\Entity\View;
use Drupal\Core\Render\Element;

/**
 * Implements hook_form_alter().
 */
function sitenow_people_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  switch ($form_id) {
    case 'node_person_edit_form':
    case 'node_person_form':
      if (isset($form['field_person_hide'])) {
        // Set field_person_hide to options group (promotion options).
        $form['field_person_hide']['#group'] = 'options';
      }

      // Extended person functionality.
      /** @var \Drupal\taxonomy\Entity\Vocabulary $terms */
      $terms = \Drupal::entityTypeManager()->getStorage('taxonomy_term')->loadTree('person_types');

      if (empty($terms)) {
        // If there are no terms, field_person_type is not required.
        $form['field_person_type']['#widget']['#required'] = FALSE;
        $form['field_person_type']['#access'] = FALSE;

        // Loop through fields.
        foreach (Element::children($form) as $field_name) {
          // If the field name matches the pattern for person type
          // specific fields, make it not required and set it to
          // not be visible.
          if (strpos($field_name, 'pt_') !== FALSE) {
            $form[$field_name]['#widget']['#required'] = FALSE;
            $form[$field_name]['#access'] = FALSE;
          }
        }
      }
      else {
        // Loop through terms.
        foreach ($terms as $term) {
          // Loop through fields.
          foreach (Element::children($form) as $field_name) {
            // Check for match of term name (lower-cased) in the field name.
            if (strpos($field_name, 'pt_' . strtolower($term->name)) !== FALSE) {
              // Add '#states' condition to matching fields to be visible
              // when tid is selected in field_person_type.
              // @todo Do we need to account for the possibility of changing
              //   the widget type?
              $form[$field_name]['#states']['visible'][] = [
                ':input[name="field_person_type[' . $term->tid . ']"]' => [
                  'checked' => TRUE,
                ],
              ];
            }
          }
        }
      }

      // If it exists, change the 'Link text' field to say 'Label' on
      // the website field, because that makes more sense in this context.
      if (isset($form['field_person_website'])) {
        foreach (Element::children($form['field_person_website']['widget']) as $k) {
          $form['field_person_website']['widget'][$k]['title']['#title'] = t('Label');
        }
      }

      break;
  }
}

/**
 * Implements hook_entity_presave().
 */
function sitenow_people_entity_presave(EntityInterface $entity) {
  switch ($entity->bundle()) {
    case 'person':
      // Setting the title with the first/last name values.
      $output = $entity->get('field_person_first_name')->value . " " . $entity->get('field_person_last_name')->value;
      $entity->setTitle($output);
      break;

  }
}

/**
 * Alter the fields used to represent an entity in the IEF table.
 *
 * @param array $fields
 *   The fields, keyed by field name.
 * @param array $context
 *   An array with the following keys:
 *   - parent_entity_type: The type of the parent entity.
 *   - parent_bundle: The bundle of the parent entity.
 *   - field_name: The name of the reference field on which IEF is operating.
 *   - entity_type: The type of the referenced entities.
 *   - allowed_bundles: Bundles allowed on the reference field.
 *
 * @see \Drupal\inline_entity_form\InlineFormInterface::getTableFields()
 */
function sitenow_people_inline_entity_form_table_fields_alter(array &$fields, array $context) {
  if ($context['entity_type'] == 'node') {
    // Clean up, minimize the person IEF form.
    if (in_array('person', $context['allowed_bundles'])) {
      unset($fields['label']);
      unset($fields['status']);
      $fields['field_person_first_name'] = [
        'type' => 'field',
        'label' => t('First Name'),
        'weight' => 0,
      ];
      $fields['field_person_last_name'] = [
        'type' => 'field',
        'label' => t('Last Name'),
        'weight' => 1,
      ];
      $fields['moderation_state'] = [
        'type' => 'field',
        'label' => t('State'),
        'weight' => 2,
      ];
    }
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function sitenow_people_preprocess_page_title(&$variables) {
  $admin_context = \Drupal::service('router.admin_context');
  if (!$admin_context->isAdminRoute()) {
    $route_name = \Drupal::routeMatch()->getRouteName();
    if ($route_name == 'entity.node.canonical') {
      $node = \Drupal::routeMatch()->getParameter('node');
    }
    elseif ($route_name == 'entity.node.preview') {
      $node = \Drupal::routeMatch()->getParameter('node_preview');
    }
    if (isset($node)) {
      switch ($node->getType()) {
        case 'person':
          if ($node->hasField('field_person_credential') && !$node->get('field_person_credential')
            ->isEmpty()) {
            $variables['subtitle'] = $node->field_person_credential->value;
          }
          break;
      }
    }
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function sitenow_people_preprocess_page(&$variables) {
  $current_route = \Drupal::routeMatch();
  $route_name = $current_route->getRouteName();
  if (strpos($route_name, 'view.people.') === 0) {
    // Get the current user.
    $user = \Drupal::currentUser();
    // Check for permission.
    if ($user->hasPermission('administer sitenow people') == TRUE) {
      // Print warning message informing user to use SiteNow People settings.
      $url = Url::fromRoute('sitenow_people.settings_form');
      $settings_link = Link::fromTextAndUrl(t('SiteNow People'), $url)
        ->toString();
      if ($route_name == 'view.people.page_people_table') {
        $message_text = t('This page can be configured here: @settings_link.
        This page is currently manually sorted.
        You can adjust the order by dragging the arrows up/down and then clicking "Save order" at the bottom of this page.', [
          '@settings_link' => $settings_link,
        ]);
      }
      else {
        $message_text = t('This page can be configured here: @settings_link', [
          '@settings_link' => $settings_link,
        ]);
      }

      \Drupal::messenger()->addStatus($message_text);
    }
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function sitenow_people_preprocess_views_view(&$variables) {
  switch ($variables["id"]) {
    case 'people':
      // Unset header content if empty.
      if (empty($variables["header"]["area"]["#text"])) {
        unset($variables["header"]["area"]);
      }
      break;

  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function sitenow_people_preprocess_node(&$variables) {
  $admin_context = \Drupal::service('router.admin_context');
  if (!$admin_context->isAdminRoute()) {
    $node = $variables["node"];
    switch ($node->getType()) {
      case 'person':
        switch ($variables['view_mode']) {
          case 'teaser':
            // Heading needs to change based on placement. Defaults to h3 in twig.
            $current_route = \Drupal::routeMatch();
            $route_name = $current_route->getRouteName();
            $variables['#cache']['contexts'][] = 'route.name';
            if (strpos($route_name, 'view.people.') === 0) {
              $variables['content_heading'] = 'h2';
            }
            break;
        }
        break;
    }
  }

}

/**
 * Implements hook_preprocess_HOOK().
 */
function sitenow_people_preprocess_field(&$variables) {
  switch ($variables["element"]["#field_name"]) {
    // Change header class for person position based on view mode.
    case 'field_person_position':
      switch ($variables["element"]["#view_mode"]) {
        case 'full':
          $variables['attributes']['class'][] = 'h5';
          break;

        case 'teaser':
          $variables['attributes']['class'][] = 'h6';
          break;
      }
      break;
  }
}

/**
 * Implements hook_uip_classes_alter().
 */
function sitenow_people_uip_classes_alter(&$options, $entity, $bundle) {
  switch ($bundle) {
    case 'people':
      $options['hide-descriptions'] = 'Hide Biographies';
      $options['hide-images'] = 'Hide Images';
      $options['grid'] = 'Grid';
      $options['masonry'] = 'Masonry';
      break;
  }
}

/**
 * Implements hook_views_pre_render().
 */
function sitenow_people_views_pre_render(ViewExecutable $view) {
  // Add <th> label for Draggable Views, otherwise it is flagged
  // for accessibility.
  if ($view->id() == "people" && $view->current_display == 'page_people_table') {
    $view->field["draggableviews"]->options["label"] = 'Sort Control';
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function sitenow_people_preprocess_paragraph(&$variables) {
  $paragraph = $variables['paragraph'];
  switch ($paragraph->bundle()) {
    case 'people':
      $admin_context = \Drupal::service('router.admin_context');
      if (!$admin_context->isAdminRoute()) {

        // Display title if it exists.
        if ($paragraph->hasField('field_uip_display_title')) {
          if ($paragraph->field_uip_display_title->value == 1) {
            $variables['display_title'] = TRUE;
          }
        }

        if ($paragraph->hasField('field_uip_classes') && !$paragraph->get('field_uip_classes')->isEmpty()) {
          $classes = $paragraph->get('field_uip_classes')->getValue();
          // Clean array of classes selected.
          $classes = array_column($classes, 'value');
          // Check for grid classes otherwise add list class.
          $display_options = [
            'grid',
            'masonry',
          ];
          $result = array_intersect($display_options, $classes);
          if (!$result) {
            $variables['attributes']['class'][] = 'list';
          }
        }
        else {
          $variables['attributes']['class'][] = 'list';
        }
        // Get field_uip_colwidth value.
        if ($paragraph->hasField('field_uip_colwidth')) {
          $variables['attributes']['class'][] = $paragraph->field_uip_colwidth->value;
        }
        // Get field_uip_id value.
        if ($paragraph->hasField('field_uip_id')) {
          $variables['attributes']['id'][] = Html::getUniqueId($paragraph->field_uip_id->value);
        }

        if ($paragraph->hasField('field_people_sort') && !$paragraph->get('field_people_sort')->isEmpty()) {
          if ($paragraph->field_people_sort->value == 'block_people_slf') {
            $view = Views::getView('people_block');
            $view->setDisplay('block_people_slf');
          }
          elseif ($paragraph->field_people_sort->value == 'block_people_sfl') {
            $view = Views::getView('people_block');
            $view->setDisplay('block_people_sfl');
          }
        }

        if ($paragraph->hasField('field_reference') && !$paragraph->get('field_reference')->isEmpty()) {
          $tids = $paragraph->get('field_reference')->getValue();
          // Clean array of tids selected.
          $tids = array_column($tids, 'target_id');
        }
        else {
          $tids = ['all'];
        }
        // Contextual relationship filter.
        $args = implode('+', $tids);
        $view->setArguments([$args]);

        if ($paragraph->hasField('field_uip_items') && !$paragraph->get('field_uip_items')->isEmpty()) {
          $items = $paragraph->field_uip_items->value;
          $view->setItemsPerPage($items);
          $view->setExposedInput([
            'items_per_page' => $items,
          ]);
        }
        $pager_type = 'some';
        // Show pager if it exists and is set.
        if ($paragraph->hasField('field_uip_pager')) {
          if ($paragraph->field_uip_pager->value == 1) {
            $pager_type = 'full';
          }
        }

        $pager = $view->display_handler->getOption('pager');
        // IF show pager, change pager_type to 'full'.
        $pager['type'] = $pager_type;
        $view->display_handler->setOption('pager', $pager);

        $view->preExecute();
        $view->execute();
        $variables['content']['view'] = $view->render();

        // If we have more link checked and link provided, pass it.
        if ($paragraph->hasField('field_people_more')) {
          $more = ($paragraph->field_people_more->value == 1) ? TRUE : FALSE;
          if ($more == TRUE) {
            $variables['more'] = [
              '#type' => 'container',
              '#attributes' => [
                'class' => 'more-link',
              ],
            ];

            $view = View::load('people');
            $default =& $view->getDisplay('default');

            if (!empty($more_path = $paragraph->get('field_people_more_path')->getValue())) {
              $url = Url::fromUri($more_path[0]['uri']);
            }

            // Check to see if other displays are enabled before setting more link.
            $displays = [
              'page_people_sfl',
              'page_people_slf',
              'page_people_table',
            ];
            foreach ($displays as $display) {
              if ($view->getDisplay($display)['display_options']['enabled'] == TRUE) {
                $url = Url::fromRoute('view.people.' . $display);
                break;
              }
            }

            if (isset($url)) {
              $variables['more']['btn'] = [
                '#type' => 'link',
                '#title' => 'View more ' . strtolower($default['display_options']['title']),
                '#url' => $url,
                '#attributes' => [
                  'class' => ['btn', 'btn-primary'],
                ],
              ];
            }
          }
        }
      }

      break;
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function sitenow_people_form_views_exposed_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $view = $form_state->get('view');
  if ($view->id() == 'people_block') {
    if ($view->current_display == 'block_people_sfl' || $view->current_display == 'block_people_slf') {
      $exposed_input = $view->getExposedInput();
      if (isset($exposed_input["items_per_page"])) {
        $form["items_per_page"]["#options"] = [$exposed_input["items_per_page"] => $exposed_input["items_per_page"]];
        $form["#attributes"]["class"][] = 'hidden';
      }
    }
  }
}

/**
 * Implements hook_field_widget_WIDGET_TYPE_form_alter().
 */
function sitenow_people_field_widget_paragraphs_form_alter(&$element, &$form_state, $context) {
  if ($element["#paragraph_type"] == 'people') {
    if (!empty($element['subform']['field_people_more'])) {
      $parents_array = $element['subform']['#parents'];
      $parents = array_shift($parents_array) . '[' . implode('][', $parents_array) . ']';
      if (!empty($element['subform']['field_people_more_path'])) {
        $element['subform']['field_people_more_path']['#states'] = [
          'visible' => [
            ':input[name="' . $parents . '[field_people_more][value]"]' => [
              'checked' => TRUE,
            ],
          ],
        ];
      }
    }
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function sitenow_people_preprocess_block(&$variables) {
  switch ($variables['elements']['#plugin_id']) {
    case 'inline_block:uiowa_people':
      $variables['#attached']['library'][] = 'uids_base/people';
      $block = $variables['elements']['content']['#block_content'];
      if ($block->hasField('field_collection_sort') && !$block->get('field_collection_sort')->isEmpty()) {
        if ($block->field_collection_sort->value == 'block_people_slf') {
          $view = Views::getView('people_block');
          $view->setDisplay('block_people_slf');
        }
        elseif ($block->field_collection_sort->value == 'block_people_sfl') {
          $view = Views::getView('people_block');
          $view->setDisplay('block_people_sfl');
        }
      }

      if ($block->hasField('field_collection_reference') && !$block->get('field_collection_reference')->isEmpty()) {
        $tids = $block->get('field_collection_reference')->getValue();
        // Clean array of tids selected.
        $tids = array_column($tids, 'target_id');
      }
      else {
        $tids = ['all'];
      }
      // Contextual relationship filter.
      $args = implode('+', $tids);
      $view->setArguments([$args]);

      // Set custom view variable to send to person teaser template.
      if ($block->hasField('field_collection_heading_size')) {
        $view->display_handler->setOption('content_heading', $block->field_collection_heading_size->value);
      }

      if ($block->hasField('field_collection_results') && !$block->get('field_collection_results')->isEmpty()) {
        $items = $block->field_collection_results->value;
        $view->setItemsPerPage($items);
        $view->setExposedInput([
          'items_per_page' => $items,
        ]);
      }
      $pager_type = 'some';
      // Show pager if it exists and is set.
      if ($block->hasField('field_collection_pager')) {
        if ($block->field_collection_pager->value == 1) {
          $pager_type = 'full';
        }
      }

      $pager = $view->display_handler->getOption('pager');
      // IF show pager, change pager_type to 'full'.
      $pager['type'] = $pager_type;
      $view->display_handler->setOption('pager', $pager);

      $view->preExecute();
      $view->execute();

      // Associate the block's cache tags with each entity in the view result so
      // that the appropriate render cache ID is cleared when the block changes.
      foreach ($view->result as $result_row) {
        $entity = $result_row->_entity;
        $entity->addCacheTags($variables['content']['#cache']['tags']);
      }

      $variables['content']['view'] = $view->render();

      // If we have more link checked and link provided, pass it.
      if ($block->hasField('field_collection_more')) {
        $more = ($block->field_collection_more->value == 1) ? TRUE : FALSE;
        if ($more == TRUE) {
          $variables['content']['more'] = [
            '#type' => 'container',
            '#attributes' => [
              'class' => 'more-link',
            ],
          ];

          $view = View::load('people');
          $default =& $view->getDisplay('default');

          if (!empty($more_path = $block->get('field_collection_more_path')->getValue())) {
            $url = Url::fromUri($more_path[0]['uri']);
          }

          // Check to see if other displays are enabled before setting more link.
          $displays = [
            'page_people_sfl',
            'page_people_slf',
            'page_people_table',
          ];
          foreach ($displays as $display) {
            if ($view->getDisplay($display)['display_options']['enabled'] == TRUE) {
              $url = Url::fromRoute('view.people.' . $display);
              break;
            }
          }

          if (isset($url)) {
            $variables['content']['more']['bttn'] = [
              '#type' => 'link',
              '#title' => 'View more ' . strtolower($default['display_options']['title']),
              '#url' => $url,
              '#attributes' => [
                'class' => ['bttn', 'bttn--primary', 'bttn--caps'],
              ],
            ];
          }
        }
      }
      break;
  }
}
