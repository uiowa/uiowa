<?php

/**
 * @file
 * Module code for signage.sites.uiowa.edu.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\user\Entity\User;

/**
 * Implements hook_form_alter().
 */
function sitessignage_core_form_alter(&$form, FormStateInterface $form_state, $form_id): void {

  // Define the forms to remove the "Other groups" field from.
  $og_audience_other_groups_forms = ['node_sign_form', 'node_sign_edit_form', 'node_slide_form', 'node_slide_edit_form'];

  // If our form ID is in the relevant list of form IDs...
  if (in_array($form_id, $og_audience_other_groups_forms, TRUE)) {

    // If our form has other_groups defined...
    if (isset($form['og_audience']['other_groups'])) {

      // Remove access from the other groups field.
      $form['og_audience']['other_groups']['#access'] = FALSE;
    }
  }

  if ($form_id == 'og_membership_default_add_form') {
    // Set our custom validation to run before the default validation,
    // so that new users are created before we add them to a group.
    array_unshift($form['#validate'], 'sitessignage_core_og_membership_validation');
  }
}

function sitessignage_core_og_membership_validation(array &$form, FormStateInterface $form_state) {
  // Access built-in check to see if user exists.
  $username_input = $form_state->getValue('uid')[0]['target_id'];
  if (is_null($username_input)) {
    // Check a username was entered
    if (!is_null($form_state->getUserInput()['uid'][0]['target_id'])) {
      $username = $form_state->getUserInput()['uid'][0]['target_id'];
      $pass = \Drupal::service('password_generator')->generate();
      // Create a new user account.
      $newUser = User::create();
      $newUser->setUsername($username);
      $newUser->setPassword($pass);
      $newUser->setEmail(uniqid('email_') . '@uiowa.edu');
      $newUser->addRole('sign_manager');
      $newUser->enforceIsNew();
      $newUser->activate();
      $newUser->save();
      // Update form_state to set target_id to new account uid.
      $form_state->set('uid'[0]['target_id'], $newUser->id());
    }
  }
}
